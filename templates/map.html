{% extends "base.html" %}
{% load static %}
{% block content %}
<div class="container">
	<h2 class="mb-4 text-center">‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏£‡πâ‡∏≤‡∏ô OTOP</h2>
	<div id="map" style="height: 600px; border-radius: 16px; box-shadow: 0 4px 24px rgba(0,0,0,0.1);"></div>
	<div class="mt-4 text-center">
		<a href="{% url 'sels' %}" class="btn btn-success">‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</a>
	</div>
</div>
<link rel="stylesheet" href="{% static 'css/styles.css' %}">

<script>
	function getQueryParam(param) {
		const urlParams = new URLSearchParams(window.location.search);
		return urlParams.get(param);
	}

	const lat = parseFloat(getQueryParam('lat'));
	const lng = parseFloat(getQueryParam('long'));
	const name = decodeURIComponent(getQueryParam('name') || '');

	function initMap() {
		let mapCenter = { lat: 13.7563, lng: 100.5018 };
		let mapZoom = 6;
		let marker = null;

		if (!isNaN(lat) && !isNaN(lng)) {
			mapCenter = { lat: lat, lng: lng };
			mapZoom = 15;
		}

		const map = new google.maps.Map(document.getElementById('map'), {
			zoom: mapZoom,
			center: mapCenter,
			mapTypeId: 'roadmap'
		});

		// Only show marker if lat/lng are provided
		if (!isNaN(lat) && !isNaN(lng)) {
			marker = new google.maps.Marker({
				position: { lat: lat, lng: lng },
				map: map,
				title: name,
				icon: {
					url: 'https://maps.google.com/mapfiles/ms/icons/red-dot.png',
					scaledSize: new google.maps.Size(48, 48)
				},
				animation: google.maps.Animation.DROP
			});
			// Stylish info window with Google Maps button
			const infoWindow = new google.maps.InfoWindow({
				content: `
					<div style="font-size:1.1em; text-align:center; padding:10px;">
						<b style="font-size:1.2em; color:#d32f2f;">${name}</b><br>
						<a href='https://www.google.com/maps/search/?api=1&query=${lat},${lng}' target='_blank' class='btn btn-danger mt-2' style="margin-top:10px; font-weight:bold; box-shadow:0 2px 8px rgba(211,47,47,0.2); transition:0.2s;">‡∏î‡∏π‡∏ö‡∏ô Google Maps üöÄ</a>
					</div>
				`
			});
			marker.addListener('click', function() {
				infoWindow.open(map, marker);
				// Animate marker with bounce and glow
				marker.setAnimation(google.maps.Animation.BOUNCE);
				marker.setIcon({
					url: 'https://maps.google.com/mapfiles/ms/icons/red-dot.png',
					scaledSize: new google.maps.Size(56, 56)
				});
				setTimeout(() => {
					marker.setAnimation(null);
					marker.setIcon({
						url: 'https://maps.google.com/mapfiles/ms/icons/red-dot.png',
						scaledSize: new google.maps.Size(48, 48)
					});
				}, 1600);
			});
			// Initial cool drop and bounce
			setTimeout(() => {
				marker.setAnimation(google.maps.Animation.BOUNCE);
				setTimeout(() => marker.setAnimation(null), 1400);
			}, 800);
		}
	}
</script>
<script async defer src="https://maps.googleapis.com/maps/api/js?key={{ api_key }}&callback=initMap"></script>
{% endblock %}
